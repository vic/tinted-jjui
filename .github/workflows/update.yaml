name: Update
on:
  push:
    branches:
      - main
    paths:
      - "templates/tinted-jjui.mustache"
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # https://crontab.guru/every-day

jobs:
  update-themes:
    uses: "tinted-theming/home/.github/workflows/shared-build-template-and-commit-themes.yml@main"
    secrets:
      token: ${{ secrets.BOT_ACCESS_TOKEN }}
    with:
      ref: ${{ github.head_ref }}
  screenshot:
    needs: [update-themes]
    name: screenshot
    runs-on: macos-latest
    env:
      GH_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}
      JJUI_REPO: ${{ github.workspace }}/jjui
      PARALLEL: 10
    strategy:
      matrix:
        step: [ 1, 50, 100, 150, 200, 250, 300, 350, 400, 450 ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: idursun/jjui
          path: jjui
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: echo '~/.nix-profile/bin' >> $GITHUB_PATH
      - run: nix profile add github:idursun/jjui
      - run: jjui --version
      - run: nix profile add nixpkgs#vhs nixpkgs#jujutsu
      - run: vhs --version
      - run: (cd ${{github.workspace}}/jjui && jj git init --colocate)
      - run: rm -rf images/ && mkdir images
      - uses: actions/cache@v4
        with:
          path: images
          key: screenshots-${{ github.head_ref }}-step${{ matrix.step }}
          enableCrossOsArchive: true
      - name: update-screenshots
        run: bash update-images.sh ${{matrix.step}} $(expr ${{matrix.step}} + 49)
  readme:
    needs: [screenshot]
    name: readme
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: .tmp/images1
          key: screenshots-${{ github.head_ref }}-step1
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images50
          key: screenshots-${{ github.head_ref }}-step50
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images100
          key: screenshots-${{ github.head_ref }}-step100
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images150
          key: screenshots-${{ github.head_ref }}-step150
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images200
          key: screenshots-${{ github.head_ref }}-step200
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images250
          key: screenshots-${{ github.head_ref }}-step250
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images300
          key: screenshots-${{ github.head_ref }}-step300
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images350
          key: screenshots-${{ github.head_ref }}-step350
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images400
          key: screenshots-${{ github.head_ref }}-step400
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - uses: actions/cache@v4
        with:
          path: .tmp/images450
          key: screenshots-${{ github.head_ref }}-step450
          enableCrossOsArchive: true
          fail-on-cache-miss: true
      - run: rm -rf images/ && mkdir images && mv .tmp/images*/* images/
      - run: bash update-readme.sh
      - name: "Commit the changes, if any"
        uses: "stefanzweifel/git-auto-commit-action@be823a7e51f116fecebc222b8307716921375992" # 5.0.1
        with:
          commit_message: "Update README with screenshots"
          branch: ${{ github.head_ref }}
          commit_user_name: "Victor Borja"
          commit_user_email: "vborja@apache.org"
          commit_author: "Victor Borja <vborja@apache.org>"

